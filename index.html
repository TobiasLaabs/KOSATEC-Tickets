<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KOSATEC IT Tickets</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  // ‚îÄ‚îÄ‚îÄ Firebase Konfiguration ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const firebaseConfig = {
    apiKey:            "AIzaSyAKhv965H5B0dj_hKzs60ZFzupBOzRzwwA",
    authDomain:        "kosatec-tickets.firebaseapp.com",
    databaseURL:       "https://kosatec-tickets-default-rtdb.europe-west1.firebasedatabase.app",
    projectId:         "kosatec-tickets",
    storageBucket:     "kosatec-tickets.firebasestorage.app",
    messagingSenderId: "167780539093",
    appId:             "1:167780539093:web:28fd4d544f9865c16c605c"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);
  const ticketsRef = ref(db, 'tickets');

  // ‚îÄ‚îÄ‚îÄ EmailJS Konfiguration ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const EMAILJS_PUBLIC_KEY   = '2ZoQIVEdE8xaxgnW4';
  const EMAILJS_SERVICE_ID   = 'service_0cdlp5e';
  const EMAILJS_TPL_ERSTELLT = 'template_3s1f4zo';
  const EMAILJS_TPL_ERLEDIGT = 'template_pufi1ic';
  const ZIEL_EMAIL           = 'systemhaus@kosatec.de';
  emailjs.init(EMAILJS_PUBLIC_KEY);

  function sendMail(templateId, ticket) {
    emailjs.send(EMAILJS_SERVICE_ID, templateId, {
      to_email:     ZIEL_EMAIL,
      id:           ticket.id,
      titel:        ticket.titel,
      beschreibung: ticket.beschreibung || '‚Äì',
      prioritaet:   ticket.prioritaet,
      kategorie:    ticket.kategorie,
      mitarbeiter:  ticket.mitarbeiter,
    }).catch(err => console.warn('EmailJS Fehler:', err));
  }
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  const PRIO = {
    Hoch:    { dot: '#ef4444', bg: '#fef2f2', text: '#b91c1c', border: '#fecaca' },
    Mittel:  { dot: '#f59e0b', bg: '#fffbeb', text: '#92400e', border: '#fde68a' },
    Niedrig: { dot: '#22c55e', bg: '#f0fdf4', text: '#15803d', border: '#bbf7d0' },
  };
  const STATUS = {
    'Offen':          { bg: '#eff6ff', text: '#1d4ed8', border: '#bfdbfe' },
    'In Bearbeitung': { bg: '#fefce8', text: '#854d0e', border: '#fde68a' },
    'Erledigt':       { bg: '#f0fdf4', text: '#166534', border: '#bbf7d0' },
  };

  function genId() {
    return 'TKT-' + Math.random().toString(36).substr(2,6).toUpperCase();
  }
  function timeAgo(ts) {
    const d = (Date.now() - ts) / 1000;
    if (d < 60) return 'Gerade eben';
    if (d < 3600) return `vor ${Math.floor(d/60)} Min`;
    if (d < 86400) return `vor ${Math.floor(d/3600)} Std`;
    return `vor ${Math.floor(d/86400)} Tagen`;
  }
  function esc(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  let allTickets = [];

  onValue(ticketsRef, snapshot => {
    allTickets = [];
    snapshot.forEach(child => {
      allTickets.push({ _key: child.key, ...child.val() });
    });
    allTickets.sort((a,b) => b.erstellt - a.erstellt);
    render();
    document.getElementById('loader').style.display = 'none';
  });

  function render() {
    const search  = document.getElementById('search').value.toLowerCase();
    const fStatus = document.getElementById('f-status').value;
    const fPrio   = document.getElementById('f-prio').value;
    const fMa     = document.getElementById('f-ma').value;

    document.getElementById('stat-offen').textContent     = allTickets.filter(t => t.status === 'Offen').length;
    document.getElementById('stat-progress').textContent  = allTickets.filter(t => t.status === 'In Bearbeitung').length;
    document.getElementById('stat-done').textContent      = allTickets.filter(t => t.status === 'Erledigt').length;
    document.getElementById('stat-crit').textContent      = allTickets.filter(t => t.prioritaet === 'Hoch' && t.status !== 'Erledigt').length;

    const filtered = allTickets.filter(t => {
      if (fStatus !== 'Alle' && t.status !== fStatus) return false;
      if (fPrio   !== 'Alle' && t.prioritaet !== fPrio) return false;
      if (fMa     !== 'Alle' && t.mitarbeiter !== fMa) return false;
      if (search && !t.titel.toLowerCase().includes(search) && !(t.beschreibung||'').toLowerCase().includes(search)) return false;
      return true;
    });

    document.getElementById('filter-count').textContent = `${filtered.length} Ticket${filtered.length !== 1 ? 's' : ''}`;

    const list = document.getElementById('ticket-list');
    if (filtered.length === 0) {
      list.innerHTML = `<div class="empty"><div class="empty-icon">üì≠</div><div style="font-size:14px">Keine Tickets gefunden</div></div>`;
      return;
    }

    list.innerHTML = filtered.map(t => {
      const pc = PRIO[t.prioritaet];
      const sc = STATUS[t.status];
      let actionBtns = '';
      if (t.status === 'Offen') {
        actionBtns = `<button class="btn-action" style="background:#fefce8;color:#854d0e;border-color:#fde68a" onclick="window._setStatus('${t._key}','In Bearbeitung')">Annehmen</button>`;
      } else if (t.status === 'In Bearbeitung') {
        actionBtns = `<button class="btn-action" style="background:#f0fdf4;color:#166534;border-color:#bbf7d0" onclick="window._setStatus('${t._key}','Erledigt')">‚úì Erledigt</button>`;
      } else {
        actionBtns = `<button class="btn-action" style="background:#f8fafc;color:#64748b;border-color:#e2e8f0" onclick="window._setStatus('${t._key}','Offen')">Wieder √∂ffnen</button>`;
      }
      return `
      <div class="ticket-card">
        <div class="prio-dot" style="background:${pc.dot}"></div>
        <div class="ticket-body">
          <div class="ticket-top">
            <span class="ticket-id">${esc(t.id)}</span>
            <span class="ticket-title">${esc(t.titel)}</span>
            <span class="ticket-kategorie">${esc(t.kategorie)}</span>
          </div>
          ${t.beschreibung ? `<div class="ticket-desc">${esc(t.beschreibung)}</div>` : ''}
          <div class="ticket-meta">
            <span class="badge" style="background:${pc.bg};color:${pc.text}">${esc(t.prioritaet)}</span>
            <span class="badge" style="background:${sc.bg};color:${sc.text};border:1px solid ${sc.border}">${esc(t.status)}</span>
            <span style="font-size:11px;color:var(--muted)">üë§ ${esc(t.mitarbeiter)}</span>
            <span style="font-size:11px;color:var(--subtle)">üïê ${timeAgo(t.erstellt)}</span>
          </div>
        </div>
        <div class="ticket-actions">
          ${actionBtns}
          <button class="btn-delete" onclick="window._deleteTicket('${t._key}')" title="L√∂schen">‚úï</button>
        </div>
      </div>`;
    }).join('');
  }

  window._render = render;

  window._setStatus = function(key, status) {
    const ticket = allTickets.find(t => t._key === key);
    if (!ticket) return;
    update(ref(db, `tickets/${key}`), { status, updated: Date.now() });
    if (status === 'Erledigt') sendMail(EMAILJS_TPL_ERLEDIGT, ticket);
  };

  const DELETE_PIN = '7459';

  window._deleteTicket = function(key) {
    const pin = prompt('üîí Admin-PIN eingeben:');
    if (pin === null) return;
    if (pin !== DELETE_PIN) {
      alert('‚ùå Falscher PIN ‚Äî L√∂schen nicht m√∂glich.');
      return;
    }
    if (!confirm('Ticket wirklich l√∂schen?')) return;
    remove(ref(db, `tickets/${key}`));
  };

  window._openModal = function() {
    document.getElementById('modal').style.display = 'flex';
    document.getElementById('f-titel').focus();
  };

  window._closeModal = function() {
    document.getElementById('modal').style.display = 'none';
    document.getElementById('f-titel').value = '';
    document.getElementById('f-beschr').value = '';
    document.getElementById('f-prioritaet').value = 'Mittel';
    document.getElementById('f-kategorie').value = 'Hardware';
    document.getElementById('f-mitarbeiter').value = 'Benjamin Behrens';
    document.getElementById('btn-submit').disabled = true;
  };

  window._checkSubmit = function() {
    document.getElementById('btn-submit').disabled = !document.getElementById('f-titel').value.trim();
  };

  window._overlayClick = function(e) {
    if (e.target.id === 'modal') window._closeModal();
  };

  window._addTicket = function() {
    const titel = document.getElementById('f-titel').value.trim();
    if (!titel) return;
    const ticket = {
      id:           genId(),
      titel,
      beschreibung: document.getElementById('f-beschr').value.trim(),
      prioritaet:   document.getElementById('f-prioritaet').value,
      kategorie:    document.getElementById('f-kategorie').value,
      mitarbeiter:  document.getElementById('f-mitarbeiter').value,
      status:       'Offen',
      erstellt:     Date.now(),
      updated:      Date.now(),
    };
    push(ticketsRef, ticket);
    sendMail(EMAILJS_TPL_ERSTELLT, ticket);
    window._closeModal();
  };

  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') window._closeModal();
  });
</script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #f4f6f9; --card: #ffffff; --border: #e2e8f0;
    --text: #1a1f2e; --muted: #64748b; --subtle: #94a3b8;
    --header: #0f172a; --accent: #3b82f6; --accent-hover: #2563eb;
  }
  body { font-family: 'DM Sans', 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

  header { background: var(--header); padding: 0 24px; height: 56px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 50; }
  .header-left { display: flex; align-items: center; gap: 10px; }
  .logo-icon { width: 30px; height: 30px; background: var(--accent); border-radius: 7px; display: flex; align-items: center; justify-content: center; font-size: 15px; }
  .header-title { color: #fff; font-weight: 800; font-size: 15px; letter-spacing: -0.3px; }
  .header-badge { background: #1e293b; color: #94a3b8; font-size: 11px; padding: 2px 8px; border-radius: 4px; font-weight: 500; }
  .live-dot { width: 7px; height: 7px; background: #22c55e; border-radius: 50%; animation: pulse 2s infinite; }
  .live-label { color: #22c55e; font-size: 11px; font-weight: 600; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
  .btn-new { background: var(--accent); color: #fff; border: none; border-radius: 7px; padding: 8px 16px; font-weight: 700; font-size: 13px; cursor: pointer; font-family: inherit; transition: background 0.15s; }
  .btn-new:hover { background: var(--accent-hover); }

  main { max-width: 1100px; margin: 0 auto; padding: 24px 16px; }

  .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }
  .stat-card { border-radius: 10px; padding: 14px 18px; border: 1px solid transparent; }
  .stat-value { font-size: 28px; font-weight: 800; line-height: 1; }
  .stat-label { font-size: 11px; color: var(--muted); margin-top: 4px; font-weight: 500; }

  .filter-bar { background: var(--card); border-radius: 10px; padding: 12px 16px; margin-bottom: 16px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; border: 1px solid var(--border); }
  .filter-bar input, .filter-bar select { border: 1px solid var(--border); border-radius: 6px; padding: 6px 12px; font-size: 13px; outline: none; background: #f8fafc; color: var(--text); font-family: inherit; }
  .filter-bar input { flex: 1 1 160px; min-width: 120px; }
  .filter-bar input:focus, .filter-bar select:focus { border-color: var(--accent); }
  .filter-count { font-size: 12px; color: var(--subtle); margin-left: auto; white-space: nowrap; }

  #ticket-list { display: flex; flex-direction: column; gap: 8px; }
  .ticket-card { background: var(--card); border-radius: 10px; border: 1px solid var(--border); padding: 14px 18px; display: flex; gap: 14px; align-items: flex-start; transition: box-shadow 0.15s; animation: fadeIn 0.2s ease; }
  .ticket-card:hover { box-shadow: 0 2px 12px rgba(0,0,0,0.06); }
  @keyframes fadeIn { from{opacity:0;transform:translateY(-4px)} to{opacity:1;transform:translateY(0)} }
  .prio-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; margin-top: 7px; }
  .ticket-body { flex: 1; min-width: 0; }
  .ticket-top { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
  .ticket-id { font-size: 11px; color: var(--subtle); font-family: 'DM Mono', monospace; font-weight: 500; }
  .ticket-title { font-weight: 700; font-size: 14px; color: var(--text); }
  .ticket-kategorie { font-size: 11px; background: #f1f5f9; color: var(--muted); border-radius: 4px; padding: 2px 7px; }
  .ticket-desc { font-size: 12px; color: var(--muted); margin-top: 5px; line-height: 1.5; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 500px; }
  .ticket-meta { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; align-items: center; }
  .badge { font-size: 11px; border-radius: 4px; padding: 2px 7px; font-weight: 600; }
  .ticket-actions { display: flex; gap: 6px; flex-shrink: 0; align-items: center; }
  .btn-action { font-size: 11px; border-radius: 5px; padding: 4px 10px; cursor: pointer; font-weight: 600; font-family: inherit; border: 1px solid transparent; transition: opacity 0.15s; }
  .btn-action:hover { opacity: 0.8; }
  .btn-delete { background: none; border: none; color: #cbd5e1; cursor: pointer; padding: 4px 6px; border-radius: 4px; font-size: 14px; font-family: inherit; transition: color 0.15s; }
  .btn-delete:hover { color: #ef4444; }

  .empty { text-align: center; padding: 52px; color: var(--subtle); background: var(--card); border-radius: 10px; border: 1px solid var(--border); }
  .empty-icon { font-size: 36px; margin-bottom: 10px; }

  #loader { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px; gap: 12px; color: var(--subtle); }
  .spinner { width: 28px; height: 28px; border: 3px solid #e2e8f0; border-top-color: var(--accent); border-radius: 50%; animation: spin 0.7s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .modal-overlay { position: fixed; inset: 0; background: rgba(15,23,42,0.6); display: flex; align-items: center; justify-content: center; z-index: 100; padding: 16px; }
  .modal { background: #fff; border-radius: 14px; padding: 28px; width: 100%; max-width: 480px; box-shadow: 0 25px 60px rgba(0,0,0,0.25); animation: slideUp 0.2s ease; }
  @keyframes slideUp { from{transform:translateY(16px);opacity:0} to{transform:translateY(0);opacity:1} }
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
  .modal-title { font-size: 16px; font-weight: 700; }
  .btn-close { background: none; border: none; font-size: 20px; cursor: pointer; color: var(--subtle); }
  .form-group { margin-bottom: 14px; }
  .form-label { font-size: 12px; font-weight: 600; color: #374151; display: block; margin-bottom: 5px; }
  .form-input, .form-select, .form-textarea { width: 100%; border: 1px solid var(--border); border-radius: 7px; padding: 8px 12px; font-size: 13px; outline: none; font-family: inherit; color: var(--text); }
  .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--accent); }
  .form-textarea { resize: vertical; min-height: 80px; }
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 14px; }
  .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
  .btn-cancel { background: #f1f5f9; color: var(--muted); border: none; border-radius: 7px; padding: 9px 18px; font-weight: 600; font-size: 13px; cursor: pointer; font-family: inherit; }
  .btn-submit { background: var(--accent); color: #fff; border: none; border-radius: 7px; padding: 9px 20px; font-weight: 700; font-size: 13px; cursor: pointer; font-family: inherit; }
  .btn-submit:hover { background: var(--accent-hover); }
  .btn-submit:disabled { background: #cbd5e1; cursor: not-allowed; }

  @media (max-width: 640px) {
    .stats-grid { grid-template-columns: repeat(2,1fr); }
    .form-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<header>
  <div class="header-left">
    <div class="logo-icon">üé´</div>
    <span class="header-title">KOSATEC IT Tickets</span>
    <span class="header-badge">KC IT Administration</span>
    <div style="display:flex;align-items:center;gap:5px;margin-left:8px">
      <div class="live-dot"></div>
      <span class="live-label">Live</span>
    </div>
  </div>
  <button class="btn-new" onclick="window._openModal()">+ Neues Ticket</button>
</header>

<main>
  <div class="stats-grid">
    <div class="stat-card" style="background:#eff6ff;border-color:#bfdbfe">
      <div class="stat-value" style="color:#1d4ed8" id="stat-offen">‚Äì</div>
      <div class="stat-label">Offen</div>
    </div>
    <div class="stat-card" style="background:#fefce8;border-color:#fde68a">
      <div class="stat-value" style="color:#854d0e" id="stat-progress">‚Äì</div>
      <div class="stat-label">In Bearbeitung</div>
    </div>
    <div class="stat-card" style="background:#f0fdf4;border-color:#bbf7d0">
      <div class="stat-value" style="color:#166534" id="stat-done">‚Äì</div>
      <div class="stat-label">Erledigt</div>
    </div>
    <div class="stat-card" style="background:#fef2f2;border-color:#fecaca">
      <div class="stat-value" style="color:#b91c1c" id="stat-crit">‚Äì</div>
      <div class="stat-label">Kritisch (offen)</div>
    </div>
  </div>

  <div class="filter-bar">
    <input type="text" id="search" placeholder="Suchen..." oninput="window._render()">
    <select id="f-status" onchange="window._render()">
      <option>Alle</option><option>Offen</option><option>In Bearbeitung</option><option>Erledigt</option>
    </select>
    <select id="f-prio" onchange="window._render()">
      <option>Alle</option><option>Hoch</option><option>Mittel</option><option>Niedrig</option>
    </select>
    <select id="f-ma" onchange="window._render()">
      <option>Alle</option>
      <option>Benjamin Behrens</option>
      <option>Sascha Berg</option>
      <option>Tobias Laabs</option>
      <option>Christina Leinweber</option>
      <option>Carsten Nause</option>
      <option>Lars Buchheister</option>
      <option>‚Äì Platzhalter ‚Äì</option>
    </select>
    <span class="filter-count" id="filter-count"></span>
  </div>

  <div id="ticket-list">
    <div id="loader">
      <div class="spinner"></div>
      <span style="font-size:13px">Verbinde mit Firebase...</span>
    </div>
  </div>
</main>

<div class="modal-overlay" id="modal" style="display:none" onclick="window._overlayClick(event)">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">Neues Ticket erstellen</span>
      <button class="btn-close" onclick="window._closeModal()">‚úï</button>
    </div>
    <div class="form-group">
      <label class="form-label">Titel *</label>
      <input class="form-input" id="f-titel" placeholder="Kurze Beschreibung des Problems" oninput="window._checkSubmit()">
    </div>
    <div class="form-group">
      <label class="form-label">Beschreibung</label>
      <textarea class="form-textarea" id="f-beschr" placeholder="Details, Fehlermeldung, betroffene Systeme..."></textarea>
    </div>
    <div class="form-grid">
      <div>
        <label class="form-label">Priorit√§t</label>
        <select class="form-select" id="f-prioritaet">
          <option>Mittel</option><option>Hoch</option><option>Niedrig</option>
        </select>
      </div>
      <div>
        <label class="form-label">Kategorie</label>
        <select class="form-select" id="f-kategorie">
          <option>Hardware</option><option>Software</option><option>Netzwerk</option>
          <option>Drucker/Peripherie</option><option>Zugang/Berechtigungen</option><option>Sonstiges</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Zust√§ndiger Mitarbeiter</label>
      <select class="form-select" id="f-mitarbeiter">
        <option>Benjamin Behrens</option>
        <option>Sascha Berg</option>
        <option>Tobias Laabs</option>
        <option>Christina Leinweber</option>
        <option>Carsten Nause</option>
        <option>Lars Buchheister</option>
        <option>‚Äì Platzhalter ‚Äì</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="window._closeModal()">Abbrechen</button>
      <button class="btn-submit" id="btn-submit" onclick="window._addTicket()" disabled>Ticket erstellen</button>
    </div>
  </div>
</div>

</body>
</html>
